

################################################################################
####
#### Script to create Historical EU-Map
####
################################################################################

# load packages
library(sf)
library(tidyverse)
library(leaflet)

# create basemap with limited zoom
map <- leaflet(options = leafletOptions(minZoom = 0, maxZoom = 100, zoomSnap = 0.1)) 

# add layers
map <- map %>% 
  addProviderTiles(providers$CartoDB.Positron, group = "Stamen Toner") %>%
  addProviderTiles(providers$Esri.WorldImagery, group = "Satellite") %>%
  # addTiles(
  #   urlTemplate = "https://wmts.geo.admin.ch/1.0.0/ch.swisstopo.pixelkarte-farbe/default/current/3857/{z}/{x}/{y}.jpeg",
  #   attribution = "© swisstopo",
  #   group = "Swisstopo"
  # ) %>%
  # Add layers control right after defining all base layers
  addLayersControl(
    baseGroups = c("Stamen Toner", "Satellite"),  # Matching exactly with group names above
    position = "topleft",
    options = layersControlOptions(collapsed = TRUE)
  )

map



# # Add alp-shape
alps <- st_read("data/gis_data/Alpine_Convention_Perimeter_2018_v2.shp", quiet = TRUE)
str(alps)

# First ensure valid geometry
alps <- st_make_valid(alps)

# # Transform to WGS84 with explicit CRS definitions
alps <- st_transform(alps, crs = st_crs(4326), agr = "constant")

map <- map %>%
  addPolygons(
    data = alps,
    fillColor = "red",
    fillOpacity = 0.2,
    color = "black",
    weight = 1,
    popup = "Alpenbogen"
  )

map


###############################################################################
###############################################################################
### make separate shapefiles in qgis for each point -> export to data folder
###############################################################################
###############################################################################


custom_colors <- c("#154b79", "#2d7ec0", "#95c3e5")  # Adjust colors as needed

# Add population point shapes
aut_shapefile <- st_read("data/gis_data/aut.shp", quiet = TRUE)
str(aut_shapefile)

map <- map %>% 
  addCircleMarkers(
    data = aut_shapefile,
    color = "#154b79",
    weight = 0.7,
    radius = 20, opacity = 1, fillOpacity = 1,
    popup = ~paste0(
      "<b>Österreich</b>",
      "<ul>",
      "<li>Der Braunbär wurde in Österreich im 19. Jahrhundert ausgerottet.</li>",
      "<li>1971 wurde er in ganz Österreich unter gesetzlichen Schutz gestellt.</li>",
      "<li>Bereits ein Jahr später, 1972, wanderte das erste Männchen, der sogenannte «Ötscherbär», aus Slowenien ein.</li>",
      "<li>Im Rahmen eines Wiederansiedlungsprojekts wurden zwischen 1989 und 1993 drei Bären aus Slowenien ausgewildert.</li>",
      "<li>In der Folge wurden zahlreiche Reproduktionen festgestellt; zeitweise lebten 20 bis 30 Bären in Österreich.</li>",
      "<li>2011 erreichte der Bestand seinen Tiefpunkt: Seither gilt die Population als erloschen.</li>",
      "<li>Bis heute werden sporadisch einzelne wandernde Tiere nachgewiesen – vor allem in Kärnten, Tirol und Vorarlberg.</li>",
      "</ul>"
    )
  )

map


# Add population point shapes
it_shapefile <- st_read("data/gis_data/it.shp", quiet = TRUE)
str(it_shapefile)

map <- map %>% 
  addCircleMarkers(
    data = it_shapefile,
    color = "#154b79",
    weight = 0.7,
    radius = 20, opacity = 1, fillOpacity = 1,
    popup = ~paste0(
      "<b>Trentino</b>",
      "<ul>",
      "<li>Im Jahr 1939 wurde der Braunbär in ganz Italien unter strengen Schutz gestellt.</li>",
      "<li>In den 1970er-Jahren erforschte der Schweizer Hans Ulrich Roth die Bärenpopulation im Trentino.</li>",
      "<li>In den 1990er-Jahren erreichte die Population ihren Tiefstand: Es wurden keine Reproduktionen mehr verzeichnet, und es existierten nur noch einzelne Individuen.</li>",
      "<li>Zwischen 1999 und 2002 wurden im Rahmen des Projekts «LIFE Ursus» sieben Weibchen und drei Männchen aus Slowenien ausgewildert.</li>",
      "<li>Ab 2002 erholte sich die Population kontinuierlich; jährlich wurden Reproduktionen nachgewiesen.</li>",
      "<li>2007 kam die Problembärin JURKA, eine im Rahmen von LIFE Ursus ausgewilderte slowenische Bärin, in Gefangenschaft. Seitdem sorgen immer wieder einzelne Problembären für Aufsehen.</li>",
      "<li>Aktuell (2023) wird die Population auf rund 100 Individuen geschätzt. </li>",
      "</ul>"
    )
  )

map


# Add population point shapes
fri_shapefile <- st_read("data/gis_data/friaul.shp", quiet = TRUE)
str(fri_shapefile)

map <- map %>% 
  addCircleMarkers(
    data = fri_shapefile,
    color = "#154b79",
    weight = 0.7,
    radius = 20, opacity = 1, fillOpacity = 1,
    popup = ~paste0(
      "<b>Friaul-Julisch Venetien</b>",
      "<ul>",
      "<li>Seit dem frühen 20. Jahrhundert war der Braunbär in dieser Region ausgerottet.</li>",
      "<li>Seit den 1960er- und 1970er-Jahren wurden immer wieder sporadisch durchwandernde Männchen aus Slowenien nachgewiesen.</li>",
      "<li>Seit 2004 wird in der Region ein systematisches Monitoring betrieben.</li>",
      "<li>Im Jahr 2024 gelang an der Grenze zu Slowenien mittels Fotofalle der Nachweis eines Weibchens mit Jungen.</li>",
      "</ul>"
    )
  )

map


# Add population point shapes
# fr_shapefile <- st_read("data/gis_data/fr_alps.shp", quiet = TRUE)
# str(fr_shapefile)
# 
# map <- map %>% 
#   addCircleMarkers(
#     data = fr_shapefile,
#     color = "#154b79",
#     weight = 0.7,
#     radius = 20, opacity = 1, fillOpacity = 1,
#     popup = ~paste0(
#       "<b>Französische Alpen</b>",
#       "<ul>",
#       "<li>Seit der Ausrottung im 19. Jahrhundert existiert hier keine Population mehr.</li>",
#       "<li>Vereinzelt werden durchziehende Einzeltiere – bisher ausschliesslich Männchen – im Gebiet nachgewiesen.</li>",
#       "</ul>"
#     )
#   )
# 
# map



# Add population point shapes
slo_shapefile <- st_read("data/gis_data/slo.shp", quiet = TRUE)
str(slo_shapefile)

map <- map %>% 
  addCircleMarkers(
    data = slo_shapefile,
    color = "#2d7ec0",
    weight = 0.7,
    radius = 20, opacity = 1, fillOpacity = 1,
    popup = ~paste0(
      "<b>Dinariden-Pindos</b>",
      "<ul>",
      "<li>Die Bären im Balkan sind nie ausgestorben und der Bestand gilt als stabil.</li>",
      "<li>Das grösste Vorkommen ist in den Dinariden zu finden (über 4000 Individuen in den Jahren 2017-2022/2023); eine weitere, kleinere Population befindet sich im östlichen Balkan (über 2017-460 in den Jahren 2022/2023.</li>",
      "<li>Die Dinariden-Pindos-Population gilt als Quellpopulation für Abwanderungen nach Österreich und Italien.</li>",
      "</ul>"
    )
  )

map


# Add population point shapes
pyr_shapefile <- st_read("data/gis_data/pyr.shp", quiet = TRUE)
str(pyr_shapefile)

map <- map %>% 
  addCircleMarkers(
    data = pyr_shapefile,
    color = "#95c3e5",
    weight = 0.7,
    radius = 20, opacity = 1, fillOpacity = 1,
    popup = ~paste0(
      "<b>Pyrenäen</b>",
      "<ul>",
      "<li>1989 wurde letztmals eine erfolgreiche Fortpflanzung dokumentiert.</li>",
      "<li>1990 erreichte die Population mit rund 10 Individuen ihren Tiefpunkt.</li>",
      "<li>1996 und 1997 wurden im Rahmen eines Wiederansiedlungsprojekts zwei Weibchen und ein Männchen aus Slowenien ausgewildert, weitere Individuen folgten ab 2006.</li>",
      "<li>Seither verzeichnen die offiziellen, gemeinsam von Frankreich und Spanien durchgeführten Zählungen einen kontinuierlichen Anstieg – auf rund 86 Individuen im Jahr 2023.</li>",
      "</ul>"
    )
  )

map


# Add population point shapes
can_shapefile <- st_read("data/gis_data/cant.shp", quiet = TRUE)
str(can_shapefile)

map <- map %>% 
  addCircleMarkers(
    data = can_shapefile,
    color = "#BFEFFF",
    weight = 0.7,
    radius = 20, opacity = 1, fillOpacity = 1,
    popup = ~paste0(
      "<b>Kantabrien</b>",
      "<ul>",
      "<li>In den 1980er-Jahren sank der Bestand auf unter 100 Tiere.</li>",
      "<li>Bis 2024 hat sich die Population dank zahlreicher Massnahmen aber ohne Auswilderungen erholt und zählt über 320 Individuen.</li>",
      "</ul>"
    )
  )

map



# Add population point shapes
ab_shapefile <- st_read("data/gis_data/abruz.shp", quiet = TRUE)
str(ab_shapefile)

map <- map %>% 
  addCircleMarkers(
    data = ab_shapefile,
    color = "gray",
    weight = 0.7,
    radius = 20, opacity = 1, fillOpacity = 1,
    popup = ~paste0(
      "<b>Zentral-Apennin</b>",
      "<ul>",
      "<li>Diese Population ist nie ausgestorben, erreichte jedoch in den 1970er-Jahren ihren Tiefstand. Seither hat sie sich nur langsam erholt.</li>",
      "<li>Aktuelle Schätzungen (2023) gehen von rund 50 Individuen aus.</li>",
      "<li>Das Hauptverbreitungsgebiet der Bären liegt im Nationalpark «Parco Nazionale d’Abruzzo, Lazio e Molise».</li>",
      "</ul>"
    )
  )

map

# add legend
map <- map %>% 
  addLegend(position = "topright", 
            colors = c("#154b79", "#2d7ec0", "#95c3e5", "#BFEFFF", "gray"), 
            labels = c("Alpen", "Dinariden-Pindos", "Pyrenäen", "Kantabrien", "Zentral-Apennin"),
            title = "Population",
            opacity = 1)

map

# coordinates from all shapes
long <- c(13.6,13.8,-4.36,6.38,13,10.8,0.49,14.6)
lat <- c(42.3,47.5,42.89,44.74,46.4,46.2,42.72,46.1)


# Add zoom button -> mean
map <- map %>%
  setView(lng = mean(long), 
          lat = mean(lat), 
          zoom = 5) %>%  # Adjust zoom level as needed
  addEasyButton(easyButton(
    position = "topleft",
    icon = "fa-globe",
    title = "Reset Zoom",
    onClick = JS("function(btn, map){ 
                   map.setView([", mean(lat), ", ", 
                 mean(long), "], 5);
                }")))

map

# Add logo
library(base64enc)
library(png)
# Read logo PNG
logo <- readPNG("data/gis_data/LOGO_KORA_RGB_OC.png")

# Save it temporarily to a raw PNG file in memory
tmpfile <- tempfile(fileext = ".png")
writePNG(logo, target = tmpfile)

# Encode PNG file to base64
logo_base64 <- base64enc::dataURI(file = tmpfile, mime = "image/png")

map <- map %>%
  addControl(
    html = sprintf(
      "<div style='background: transparent; padding: 0; box-shadow: none;'>
         <img src='%s' style='width:100px;height:auto;'>
       </div>", 
      logo_base64
    ),
    position = "bottomleft"
  )

map


eu_hist_map <- map

library(htmlwidgets)
saveWidget(eu_hist_map, file = "maps/eu_hist_map.html", selfcontained = TRUE)

